<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="favicons/music_note_32.ico" sizes="32x32" />

  <title>Arpeggio Flow – Arpeggio Practice Generator</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />

  <!-- VexFlow -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>

  <!-- Tonal -->
  <script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>

  <!-- VexChords -->
  <script src="libs/vexchords/vexchords.dev.js"></script>

  <!-- Fretboard.js UMD build -->
  <script src="libs/fretboard/fretboard.umd.js"></script>

  <!-- cagedShapes.js -->
  <script src="cagedShapes.js"></script>

  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Strudel (web bundle) -->
  <script src="https://unpkg.com/@strudel/web@1.2.6"></script>
</head>

<body>
  <div class="page">
    <!-- App header -->
    <header class="app-header">
      <div class="app-header-main">
        <div class="app-title">
          <h1>Arpeggio Flow</h1>
          <p class="app-tagline">
            Generate arpeggio exercises from keys, progressions and CAGED shapes.
          </p>
        </div>

        <a
          href="https://github.com/vncntprvst/ArpeggioFlow"
          class="app-header-link"
          target="_blank"
          rel="noopener noreferrer"
        >
          View on GitHub
        </a>
      </div>

      <!-- Library status (hidden once everything is loaded) -->
      <div id="status" class="status-banner">
        Checking VexFlow, Tonal and VexChords Libraries...
      </div>
    </header>

    <!-- Main 2‑column layout -->
    <main class="layout">
      <!-- Left: exercise settings -->
      <section class="controls-panel" aria-label="Exercise settings">
        <form id="exerciseForm" class="controls-form" novalidate>
          <!-- Step 1: Key & scale -->
          <div class="form-section">
            <h2 class="section-title">1. Key &amp; Scale</h2>

            <div class="form-row">
              <div class="form-field">
                <label for="key">Key</label>
                <select id="key" name="key" required>
                  <option value="A">A</option>
                  <option value="Bb">Bb</option>
                  <option value="B">B</option>
                  <option value="C" selected>C</option>
                  <option value="Db">Db</option>
                  <option value="D">D</option>
                  <option value="Eb">Eb</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="F#">F#</option>
                  <option value="G">G</option>
                  <option value="Ab">Ab</option>
                </select>
              </div>

              <div class="form-field">
                <label for="scaleType">Scale</label>
                <select id="scaleType" name="scaleType" required>
                  <option value="major" selected>Major</option>
                  <option value="minor">Minor</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Step 2: Progression & length -->
          <div class="form-section">
            <h2 class="section-title">2. Progression &amp; Length</h2>

            <div class="form-row">
              <div class="form-field">
                <label for="progression">Chord progression</label>
                <select id="progression" name="progression" required>
                  <option value="ii-V-I" selected>ii – V – I</option>
                  <option value="I-vi-ii-V">I – vi – ii – V</option>
                  <option value="I-vi-IV-V">I – vi – IV – V</option>
                  <option value="I-IV-vi-V">I – IV – vi – V</option>
                  <option value="I-I-I-I-IV-IV-I-I-V-IV-I-V">12 bar blues</option>
                </select>
              </div>

              <div class="form-field">
                <label for="bars">Number of bars</label>
                <input
                  type="number"
                  id="bars"
                  name="bars"
                  value="3"
                  min="1"
                  required
                />
              </div>
            </div>
          </div>

          <!-- Step 3: CAGED shape -->
          <div class="form-section">
            <h2 class="section-title">3. CAGED Shape</h2>

            <div class="form-row">
              <div class="form-field">
                <label for="scaleSystem">Scale system</label>
                <select
                  id="scaleSystem"
                  name="scaleSystem"
                  required
                  onchange="updateShapeOptions()"
                >
                  <option value="CAGED_SHAPES">CAGED Shapes</option>
                  <option value="EXT_CAGED_SHAPES" selected>
                    Extended CAGED Shapes
                  </option>
                </select>
              </div>

              <div class="form-field">
                <label for="shape">Chord shape</label>
                <select id="shape" name="shape" required>
                  <option value="" disabled selected>Select a Shape</option>
                  <!-- Populated dynamically by updateShapeOptions() -->
                </select>
              </div>
            </div>
          </div>

          <!-- Step 4: Playback engine -->
          <div class="form-section">
            <h2 class="section-title">4. Playback Engine</h2>

            <div class="form-field">
              <label for="playbackEngine">Playback</label>
              <select id="playbackEngine" name="playbackEngine" required>
                <option value="off" selected>Off</option>
                <option value="strudel">Strudel</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label>Transport</label>
                <div class="button-row">
                  <button type="button" id="playbackPlayButton" class="secondary-button" disabled>
                    Play
                  </button>
                  <button type="button" id="playbackStopButton" class="secondary-button" disabled>
                    Stop
                  </button>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="tempoBpm">Tempo (BPM)</label>
                <input type="number" id="tempoBpm" name="tempoBpm" value="120" min="40" max="240" />
              </div>
            </div>

            <div
              id="playback-banner"
              class="status-banner status-banner--inline status-banner--hidden"
              role="status"
              aria-live="polite"
            ></div>
          </div>

          <!-- Primary action -->
          <div class="form-actions">
            <button type="button" id="generateButton">
              Generate Exercise
            </button>
          </div>
        </form>
      </section>

      <!-- Right: preview & export -->
      <section class="preview-panel" aria-label="Preview and export">
        <article class="card card-preview">
          <header class="card-header">
            <div>
              <!-- <h2 class="card-title">Exercise preview</h2> -->
              <!-- <p class="card-subtitle">
                Fretboard diagram and notation for the selected key and progression.
              </p> -->
            </div>
            <!-- Key debug info populated by JS -->
            <p id="key-debug"></p>
          </header>

          <div class="card-body">
            <!-- Everything inside this block is exported to PNG/PDF -->
            <div id="exercise-export">
              <div id="export-title"></div>

              <!-- Fretboard diagram -->
              <div id="fretboard-container"></div>

              <!-- Music notation -->
              <div id="notation"></div>

              <!-- Arpeggio chord diagrams -->
              <div id="arpeggio-diagrams"></div>
            </div>
          </div>

          <footer class="card-footer card-footer-actions">
            <button type="button" id="exportPngButton">
              Export PNG
            </button>
            <button type="button" id="exportPdfButton">
              Export PDF
            </button>
          </footer>
        </article>
      </section>
    </main>
  </div>

  <!-- Note flow pure functions (must load before flow.js) -->
  <script src="noteFlow.js"></script>

  <!-- Main script -->
  <script type="module" src="flow.js?v=20250711"></script>

  <!-- Shape options setup (unchanged logic) -->
  <script>
    function updateShapeOptions() {
      const scaleSystem = document.getElementById('scaleSystem').value;
      const shapeSelect = document.getElementById('shape');
      shapeSelect.innerHTML = ''; // Clear current options

      const cagedShapes = ['C', 'A', 'G', 'E', 'D'];
      const extCagedShapes = ['C', 'A', 'A_stretched', 'G', 'E', 'E_stretched', 'D'];

      const shapes = scaleSystem === 'EXT_CAGED_SHAPES' ? extCagedShapes : cagedShapes;

      shapes.forEach(shape => {
        const option = document.createElement('option');
        option.value = shape;
        option.textContent = shape + ' Shape';
        shapeSelect.appendChild(option);
      });
    }

    window.onload = function () {
      document.getElementById('scaleSystem').value = 'EXT_CAGED_SHAPES';
      updateShapeOptions();
    };
  </script>
</body>
</html>
